<!--
   
   Copyright (c) 2020, the Regular Table Authors.
   
   This file is part of the Regular Table library, distributed under the terms of
   the Apache License 2.0.  The full license can be found in the LICENSE file.

-->

<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <script src="../dist/umd/regular-table.js"></script>
    <link rel='stylesheet' href="../dist/css/material.css">
</head>

<body>

    <regular-table></regular-table>

    <script>
        function createTextCells(count, text) {
            return Array.from(Array(count).keys()).map(idx => `${text} ${idx}`);
        }
                
        function createColumns(columns, count) {
            const columnKey = () => {
                const keys = columns;
                return keys[Math.floor(Math.random() * keys.length)];
            }
            return Array.from(Array(count)).map((_, idx) => {
                const key = columnKey();
                return { 
                    key,
                    value: `${key} Column ${idx}`
                };
            });
        }

        function createDataset(columns, cell_count) {
            return columns.reduce((prev, curr) => ({
                ...prev,
                [curr]: createTextCells(cell_count, curr)
            }), {});
        }

        function createDataModel(base_columns, column_count, cell_count) {
            const dataset = createDataset(base_columns, cell_count);
            const columns = createColumns(base_columns, column_count);

            const DATA = columns.map(({ key }) => dataset[key]);
            const COLUMN_HEADERS = columns.map(({ value }) => [value]);

            const getDataSlice = (x0, y0, x1, y1) => {
                const data = DATA.slice(x0, x1).map(col => col.slice(y0, y1));
                const column_headers = COLUMN_HEADERS.slice(x0, x1);
                const num_columns = DATA.length;
                const num_rows = DATA[0].length;
                return {
                    num_rows,
                    num_columns,
                    column_headers,
                    data
                };
            };
            return {
                getDataSlice,
                columns
            }
        }

        const BASE_COLUMNS = ['Fixed', 'Not Set'];
        const COLUMN_COUNT = 20;
        const CELL_COUNT = 1000;

        // Create data model that returns a getDataSlice function and a columns array.
        const { getDataSlice, columns } = createDataModel(
            BASE_COLUMNS,
            COLUMN_COUNT,
            CELL_COUNT
        );

        // Get Regular Table element.
        const tableApi = document.getElementsByTagName('regular-table')[0];

        const FIXED_CLASS = 'fixed';

        // Clear previous cell manipulations done by this api.
        function clear(cellElement) {
            cellElement.classList.remove(FIXED_CLASS);
            cellElement.style.minWidth = '';
        }

        function getColumnName(index) {
            return columns[index].key;
        }

        // Check if cell should apply fixed min-width.
        function isFixed(cellElement) {
            // Use regular-table api to get cell metadata.
            const metadata = tableApi.get_meta(cellElement);
            const name = getColumnName(metadata.cidx);
            return name.includes("Fixed");
        }
        
        // Add "fixed" class to cell element.
        function setFixedClass(cellElement) {
            cellElement.classList.add(FIXED_CLASS);
        };

        // Set fixed min-width to cells when appropiate. 
        function applyStyle() {
            // Use regular-table api to get all rendered th and td elements.
            const ths = tableApi.get_ths();
            const tds = tableApi.get_tds();
            // Iterate over all rendered cells.
            for (const cellElement of [...ths, ...tds]) {
                clear(cellElement);
                if (isFixed(cellElement)) setFixedClass(cellElement);
            }
        }

        window.addEventListener("DOMContentLoaded", async () => {
            // Pass getDataSlice function to regular-table api.
            // Set applyStyle function to run after promise resolution.
            tableApi.setDataListener(getDataSlice);

            // Attach applyStyle function to a listener to apply changes
            // after the grid is updated.
            tableApi.addStyleListener(applyStyle);

            // Trigger table draw method to make listeners run
            await tableApi.draw();
        });
    </script>

    <style>
        .fixed {
            min-width: 80px !important;
        }
    </style>
</body>
</html>